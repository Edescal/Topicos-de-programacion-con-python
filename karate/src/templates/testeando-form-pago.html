<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!--JQuery-->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
    <!-- Scripts de Bootstrap y jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    {% block scripts %}

    {% endblock %}
    <link href="{{url_for('static', filename='css/styles.css')}}" rel="stylesheet">
    <title>Pagos</title> 
</head>
<body>
    <div class="container-fluid bg-register">
        <div class="row h-100 d-flex justify-content-center">
            <div class="col-xl-5 col-lg-7 col-md-8 col-sm-10 d-flex flex-column justify-content-evenly my-3">

                <div class="d-flex justify-content-center mb-4">
                    <a href="{{url_for('profile', id = alumno.id )}}" class="btn btn-lg btn-outline-light mx-2">Regresar al perfil de {{alumno.nombres}} {{alumno.apellido_paterno}} {{alumno.apellido_materno}}</a>
                </div>

                <div class="card bg-glass rounded-4">
                    <div class="card-body p-4">

                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <a href="{{url_for('index')}}">
                                <img src="{{url_for('static', filename = 'img/dojo-logo-blanco.png')}}" class="img-fluid scale-anim"
                                    alt="Logo del dojo" width="250">
                            </a>
                        </div>
                        
                        <h3 class="text-center">Formato de registro de pagos</h3>
                        <!-- Nota -->
                        <div data-mdb-input-init class="form-outline mb-3 mx-5 mt-3 shadow">
                            <div class="alert alert-light pt-3 text-center" role="alert">
                                <h4 class="text-center">Periodo de pago actual</h4>
                                <h5 class="text-center" id="periodo-label">Periodo de pago</h5>
                                <table class="table table-bordered lh-1 mt-3 mb-1">
                                    <tr >
                                        <td class="table-active">Nombre del alumno</td>
                                        <td>{{alumno.nombres}} {{alumno.apellido_paterno}} {{alumno.apellido_materno}}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>


                        {% if paquete != None %}
                        {% if paquete.tiene_pagos == true %}
                            {% if paquete.cant_meses_abonados > 0 %}                                {# Tiene pagos y puede abonar | Debe abonar el mes actual #}
                        <form action="{{url_for('agregar_pago_post')}}" method="post" id="form-pago" novalidate class="needs-validation">
                            {{form.csrf_token }}
                            {{form.id_alumno(value=paquete.id_alumno) }}
                                                        
                            <!-- Fecha de corte -->
                            <div data-mdb-input-init class="form-outline mb-3 mx-5 shadow">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        {{ form.fecha_corte.label }}
                                    </span>
                                    <div class="form-floating">
                                        {{ form.fecha_corte(class="form-control form-control-lg text-muted", readonly="true", type="text") }}
                                        <label for="fecha_corte">Pagar antes del</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Nota -->
                            <div data-mdb-input-init class="form-outline mb-3 shadow">
                                <div class="alert alert-light py-3" role="alert">
                                    <h4 class="text-center">Ingresa los datos del pago</h4>
                                    <strong class="lh-sm"> Nota: </strong>
                                    <p class="lh-base mb-0">
                                        El monto total del pago resulta de la suma del mes que se va a abonar en este periodo y de los meses adeudados de periodos anteriores.
                                        Si el plazo del pago vence, el mes actual se considerará como un adeudo en el siguiente periodo de pago.
                                    </p>
                                </div>
                            </div>

                            <!-- Fecha de pago -->
                            <div data-mdb-input-init class="form-outline mb-3 shadow">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor"
                                            class="bi bi-key" viewBox="0 0 16 16">
                                            <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                                            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                                        </svg>
                                        <span class="ms-3">Fecha del pago</span>
                                    </span>
                                    <div class="form-floating">
                                        {{ form.fecha_pago(class="form-control form-control-lg", min="2023-01-01") }}
                                        {{form.fecha_pago.label}}
                                        <span class="invalid-feedback my-1 px-2 fw-bold">
                                            <div class="d-flex flex-column justify-content-evenly">
                                                <small>● Ingrese una fecha válida.</small>
                                                <small>● La fecha no puede ser posterior al día actual.</small>
                                                <small>● Sólo puede elegir una fecha del mes actual.</small>
                                            </div>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Monto total -->
                            <div data-mdb-input-init class="form-outline mb-3 shadow">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        {{ form.monto.label }}
                                    </span>
                                    <span class="input-group-text">
                                        <span class="fs-4">$</span>
                                    </span>
                                    {{ form.monto(class="form-control form-control-lg", readonly="true") }}
                                    <!-- <div class="form-floating">
                                    </div> -->
                                </div>
                            </div>

                            <!-- Meses abonados y adeudados -->
                            <div class="row row-cols-2 g-2">
                                <div class="col-6">
                                    <!-- CANTIDAD ABONADOS -->
                                    <div class="form-control mb-3 shadow">
                                        <p class="text-center fs-5 fw-semibold">Detalle de abono</p>
                                        <div class="input-group my-2">
                                            <span class="input-group-text">
                                                {{form.cant_meses_abonados.label}}
                                            </span>
                                            {{form.cant_meses_abonados(class="form-control", value="1")}}
                                        </div>
                                        <!-- Abono -->
                                        <div class="input-group mb-3 shadow">
                                            <span class="input-group-text">
                                                <small>
                                                    {{form.abono.label(class="fw-semibold")}}
                                                </small>
                                            </span>
                                            <span class="input-group-text">$</span>
                                            {{form.abono(class="form-control", readonly="true")}}
                                        </div>
                                        <hr>
                                        <p>Meses que serán abonados en este periodo:</p>
                                        <li class="input-group my-2">
                                            <ul id="meses-abonados-list" class="input-group ps-0">
                                            </ul>
                                        </li>
                                    </div>
        
                                    
                                </div>
                                
                                <div class="col-6">
                                    <!-- CANTIDAD MESES ADEUDO -->
                                    <div class="form-control mb-3 shadow">
                                        <p class="text-center fs-5 fw-semibold">Detalle de adeudo</p>
                                        <div class="input-group my-2">
                                            <span class="input-group-text">
                                                {{form.cant_meses_adeudados.label}}
                                            </span>
                                            {{form.cant_meses_adeudados(class="form-control", readonly="true", value = paquete.cant_meses_adeudados )}}
                                        </div>
                                        <!-- ADEUDO -->
                                        <div class="input-group mb-3 shadow">
                                            <span class="input-group-text">
                                                <small>
                                                    {{form.adeudo.label(class="fw-semibold")}}
                                                </small>
                                            </span>
                                            <span class="input-group-text">$</span>
                                            {{form.adeudo(class="form-control", readonly="true")}}
                                        </div>
                                        <hr>
                                        <p>Meses adeudados hasta este periodo:</p>
                                        <li class="input-group my-2">
                                            <ul id="meses-adeudados-list" class="input-group ps-0">
                                            </ul>
                                        </li>
                                    </div>
        
                                    

                                </div>
                            </div>

                            <!-- Submit -->
                            <div class="d-grid justify-content-center mb-3">
                                {{ form.submit_pago(class="btn btn-primary btn-lg") }}
                            </div>

                        </form>
                            {% else %}                                                              {# Si tiene pagos y no puede abonar | Ya pagó hasta el último mes #}
                        <!-- Nota -->
                        <div data-mdb-input-init class="form-outline mb-3 shadow">
                            <div class="alert alert-light py-3" role="alert">
                                <h4 class="text-center"> No hay pagos pendientes</h4>
                                <p class="lh-base mb-0 text-center">
                                    El alumno ya cubrió el pago del periodo actual.
                                </p>
                            </div>
                        </div>

                            {% endif %}
                        {% else %}                                                                  {# Si no tiene pagos, es que es el primero #}
                        
                        <div data-mdb-input-init class="form-outline mb-3 mx-5 shadow">
                            <div class="alert alert-light py-3" role="alert">
                                <h5 class="text-center">El alumno no tiene ningún pago</h5>
                                <p class="text-center m-0">Se realizará el primer pago</p>
                            </div>
                        </div>
                        
                        
                        <form action="{{url_for('agregar_pago_post')}}" method="post" id="form-pago" novalidate class="needs-validation">
                            {{form.csrf_token }}
                            {{form.id_alumno(value=paquete.id_alumno) }}
                        
                            <!-- Fecha de corte -->
                            <div data-mdb-input-init class="form-outline mb-3 mx-5 shadow">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        {{ form.fecha_corte.label }}
                                    </span>
                                    <div class="form-floating">
                                        {{ form.fecha_corte(class="form-control form-control-lg text-muted", readonly="true", type="text") }}
                                        <label for="fecha_corte">Pagar antes del</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Nota -->
                            <div data-mdb-input-init class="form-outline mb-3 shadow">
                                <div class="alert alert-light py-3" role="alert">
                                    <h4 class="text-center">Ingresa los datos del pago</h4>
                                    <strong class="lh-sm"> Nota: </strong>
                                    <p class="lh-base mb-0">
                                        El monto total del pago resulta de la suma del mes que se va a abonar en este periodo y de los meses adeudados de periodos anteriores.
                                        Al ser este el primer pago del alumno, el alumno no cuenta con adeudos y puede abonar hasta 5 meses a partir del periodo actual.
                                    </p>
                                </div>
                            </div>

                            <!-- Fecha de pago -->
                            <div data-mdb-input-init class="form-outline mb-3 shadow">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor"
                                            class="bi bi-key" viewBox="0 0 16 16">
                                            <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                                            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                                        </svg>
                                        <span class="ms-3">Fecha del pago</span>
                                    </span>
                                    <div class="form-floating">
                                        {{ form.fecha_pago(class="form-control form-control-lg", min="2023-01-01") }}
                                        {{form.fecha_pago.label}}
                                        <span class="invalid-feedback my-1 px-2 fw-bold">
                                            <div class="d-flex flex-column justify-content-evenly">
                                                <small>● Ingrese una fecha válida.</small>
                                                <small>● La fecha no puede ser posterior al día actual.</small>
                                                <small>● Sólo puede elegir una fecha del mes actual.</small>
                                            </div>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Monto total -->
                            <div data-mdb-input-init class="form-outline mb-3 shadow">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        {{ form.monto.label }}
                                    </span>
                                    <span class="input-group-text">
                                        <span class="fs-4">$</span>
                                    </span>
                                    {{ form.monto(class="form-control form-control-lg", readonly="true") }}
                                    <!-- <div class="form-floating">
                                    </div> -->
                                </div>
                            </div>

                            <!-- Meses abonados y adeudados -->
                            <div class="row row-cols-2 justify-content-center g-2">
                                <div class="col-10">
                                    <!-- CANTIDAD ABONADOS -->
                                    <div class="form-control mb-3 shadow">
                                        <p class="text-center fs-5 fw-semibold">Detalle de abono</p>
                                        <div class="input-group my-2">
                                            <span class="input-group-text">
                                                {{form.cant_meses_abonados.label}}
                                            </span>
                                            <span class="input-group-text">$</span>
                                            {{form.cant_meses_abonados(class="form-control", value="1")}}
                                        </div>
                                        <!-- Abono -->
                                        <div class="input-group mb-3 shadow">
                                            <span class="input-group-text">
                                                <small>
                                                    {{form.abono.label(class="fw-semibold")}}
                                                </small>
                                            </span>
                                            {{form.abono(class="form-control", readonly="true")}}
                                        </div>
                                        <hr>
                                        <p>Meses que serán abonados en este periodo:</p>
                                        <li class="input-group my-2">
                                            <ul id="meses-abonados-list" class="input-group ps-0">
                                            </ul>
                                        </li>
                                    </div>
        
                                    
                                </div>
                            </div>

                            {{form.cant_meses_adeudados(class="form-control", hidden="true", value=meses_adeudados )}}
                            {{form.adeudo(class="form-control", hidden="true" )}}

                            <!-- Submit -->
                            <div class="d-grid justify-content-center mb-3">
                                {{ form.submit_pago(class="btn btn-primary btn-lg") }}
                            </div>
                        </form>                    
                    {% endif %}
                    {% endif %}
    
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>

$('#form-pago').on('submit', evt => {
    if (!evt.target.checkValidity()) {
        console.log('Formulario no validado - no enviado')
        evt.preventDefault()
        evt.stopPropagation()

        $(`#fecha_pago, #cant_meses_abonados`).each(function () {
            if (!this.checkValidity()) {
                console.log(`Input no válido: ${this.name}`)
                this.classList.remove('is-valid')
                this.classList.add('is-invalid')
            } else {
                this.classList.add('is-valid')
                this.classList.remove('is-invalid')
            }
        })
    } 
    
    if (!confirm('Se registrará la información de pago de este periodo, ¿deseas continuar? Asegúrate de que los datos sean correctos.')){
        evt.preventDefault()
        evt.stopPropagation()
    }
})

// Helpers
function parseDate(date) {
    return date.toISOString().slice(0,10)
}

function diffMeses(fecha1, fecha2) {
    return (fecha1.getFullYear() - fecha2.getFullYear()) * 12 + fecha1.getMonth() - fecha2.getMonth()
}

function nombreMes(mes) {
    if (mes== 1)
        return 'Enero'
    else if (mes == 2)
        return 'Febrero'
    else if (mes == 3)
        return 'Marzo'
    else if (mes == 4)
        return 'Abril'
    else if (mes == 5)
        return 'Mayo'
    else if (mes == 6)
        return 'Junio'
    else if (mes == 7)
        return 'Julio'
    else if (mes == 8)
        return 'Agosto'
    else if (mes == 9)
        return 'Septiembre'
    else if (mes == 10)
        return 'Octubre'
    else if (mes == 11)
        return 'Noviembre'
    else if (mes == 12)
        return 'Diciembre'
}

function conseguirLabelsMeses(cantidadMeses) {
        let currentDate = new Date()
        let nextDate = new Date()
            nextDate.setMonth(nextDate.getMonth() + cantidadMeses)
        let diferencia = diffMeses(nextDate, currentDate)
        let labels = []
        let currentYear = currentDate.getFullYear()
        for (let index = currentDate.getMonth() + 1; index < nextDate.getMonth() + 1; index++) {
            let mes = index
            if (index > 12) {
                mes = index % 12
                currentYear = Math.floor(index / 12)
            }
            let zfillMes = ('0'+mes).slice(-2);
            
            let wrapper = []
            wrapper.push(`${currentYear}-${zfillMes}`)
            wrapper.push(`${nombreMes(mes)} de ${currentYear}`)
            
            // Cada elemento devuelto será una tupla (value:display)
            labels.push(wrapper)  
        }
        return labels
    }

$(()=>{
    /*
    paquete = {
        'fecha_corte': fecha_corte,
        'cant_meses_abonados': cantidad_meses_abono,
        'meses_abonados': meses_abono,
        'cant_meses_adeudados': cantidad_meses_adeudo,
        'meses_adeudados': meses_adeudo,
        'abono': cantidad_meses_abono * 600,
        'adeudo': cantidad_meses_adeudo * 600,
        'monto': (cantidad_meses_abono * 600) + (cantidad_meses_adeudo * 600)
    }
    */
    {% if paquete != None %}
    let paquete = {{paquete | tojson | safe}} ;
    console.log(paquete)
    
    // Inicializar campos
    $('#cant_meses_abonados').val(paquete.cant_meses_abonados).prop('value', paquete.cant_meses_abonados)
    $('#cant_meses_adeudados').val(paquete.cant_meses_adeudados).prop('value', paquete.cant_meses_adeudados)
    $('#abono').val(paquete.abono).prop('value', paquete.abono)
    $('#adeudo').val(paquete.adeudo).prop('value', paquete.adeudo)

    let fechaHoy = new Date()
    
    // Obtiene la fecha del corte del siguiente mes
    let fechaCorte = new Date(Date.parse(paquete.fecha_corte)).toISOString().slice(0,10)
    
    //Inicio del mes
    let inicioMes = new Date()
        inicioMes.setDate(1)

    // Obtiene la fecha de inicio desde el siguiente mes desde el último pago
    let inicioPeriodo = new Date(paquete.fecha_ultimo_pago)

    simpleValidation = (evt) => {
        console.log(evt.currentTarget.name)
        if (!evt.currentTarget.checkValidity()) {
            evt.currentTarget.classList.remove('is-valid')
            evt.currentTarget.classList.add('is-invalid')
        } else {
            evt.currentTarget.classList.add('is-valid')
            evt.currentTarget.classList.remove('is-invalid')
        }
    }

    // Valida el input de fecha de pago para sólo poder elegir en el mes en curso
    $('#fecha_pago')
        // .attr('min', inicioPeriodo.toISOString().slice(0,10))
        .attr('min', `${inicioMes.getFullYear()}-${('0'+(inicioMes.getMonth()+1)).slice(-2)}-${('0'+inicioMes.getDate()).slice(-2)}`)
        .attr('max', `${fechaHoy.getFullYear()}-${('0'+(fechaHoy.getMonth()+1)).slice(-2)}-${('0'+fechaHoy.getDate()).slice(-2)}`)
        .on('input', simpleValidation)
        .on('blur', simpleValidation)
        .on('focus', simpleValidation)

    // Configura el corte de pago como no editable y le pone el valor que debe tener
    $('#fecha_corte').prop('type', 'text').prop('readonly', true).attr('val', fechaCorte).val(fechaCorte)
    let fechasPeriodo = conseguirLabelsMeses(2)
    let mes1 = fechasPeriodo[0][1].replace(' de ', '-')
    let mes2 = fechasPeriodo[1][1].replace(' de ', '-')
    let periodoLabel = `${mes1} a ${mes2}`
    $('#periodo-label').text(periodoLabel)

    // Configurar el input de cantidad de meses de abonos para mostrar los meses a abonar
    $('#cant_meses_abonados').on('input', evt => {
        var cantidad = $('#cant_meses_abonados').val()
        cantidad = cantidad > 5 ? 5 : cantidad < 1 ? 1 : cantidad

        $('#cant_meses_abonados').val(cantidad).attr('value', cantidad)

        let meses = conseguirLabelsMeses(cantidad)
        
        $('#meses-abonados-list').empty()
        let contador = 1
        meses.forEach(label => {
            //console.log($('#meses-abonados-list'))
            $('#meses-abonados-list').append(
                `<li class="input-group p-0 mb-0">
                    <span class="input-group-text">${contador}</span>
                    <input type="text" name="meses_abonados[]" hidden value="${label[0]}">
                    <input type="text" class="form-control shadow" readonly value="${label[1]}">
                </li>`
            )
            contador++
        })
        // El campo de abono es la cantidad de meses x 600
        $('#abono').val(cantidad * 600.0).attr('value', cantidad * 600.0)
    })

    // Configurar el input de meses de adeudo para mostrar el valor correcto
    $('#cant_meses_adeudados').on('input', evt => {
        // Aqui debe llamar al paquete y ponerle los meses adeudados en él
        $('#meses-adeudados-list').empty()
        var contador = 1
        Array.from(paquete.meses_adeudados).forEach(mes => {
            let fechaId = mes.str
            let fechaDisplay = `${nombreMes(mes.id_mes)} de ${mes.anio}`
            $('#meses-adeudados-list').append(
                `<li class="input-group p-0 mb-0">
                    <span class="input-group-text">${contador}</span>
                    <input type="text" name="meses_adeudados[]" hidden value="${fechaId}">
                    <input type="text" class="form-control shadow" readonly value="${fechaDisplay}">
                </li>`
            )
            contador++
        })

        let cantidad = $('#cant_meses_adeudados').get(0).value        
        // El campo de adeudo es la cantidad de meses x 600
        $('#adeudo').val(cantidad * 600.0).attr('value', cantidad * 600.0)
    })

    // Al moverle al form se actualiza el monto total
    $('#form-pago').on('input', evt => {
        let abono = $('#abono').val()
        let adeudo = $('#adeudo').val()
        let monto = Number(abono) + Number(adeudo)
        $('#monto').val(monto).attr('value', monto)
    })
    
    $('#cant_meses_abonados').trigger('input')
    $('#cant_meses_adeudados').trigger('input')

    {% else %}
    alert('Revisar paquete de información.')
    {% endif %}
})
</script>
</body>
</html>