{% extends 'base2.0.html' %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
{% endblock %}

{% block title %}Bienvenido{% endblock %}

{% block body %}

<div class="container-fluid bg-black">
    <div class="row justify-content-center p-5">
        
        <div class="col-sm-10 col-md-8 rounded-5 bg-glass px-5">
            <form action="{{url_for('consulta')}}" method="post" novalidate class="needs-validation" id="formulario">
                <!-- Hidden input to store the next argument -->
                <input type="hidden" name="next" id="next" value="{{ request.args.get('next', '') }}" />

                <h5 class="text-center mb-3 mt-5">Elegir clases</h5>

                <!--DATE-->
                <div data-mdb-input-init class="form-outline mb-3 shadow-sm bg-white">
                    <div class="input-group">
                        <span class="input-group-text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                                class="bi bi-key" viewBox="0 0 16 16">
                                <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                            </svg>
                        </span>
                        <div class="form-floating">
                            <input class="form-control" id="date" max="2024-05-17" min="2000-01-01" name="date" required type="date" value="" data-provider="datepicker">
                            <label for="date">Fecha de la clase</label>
                            <span class="invalid-feedback mt-3">
                                <ul class="fw-bold">
                                    <span class="badge bg-danger rounded-pill fs-6">Requisitos de la contraseña:</span>
                                    <li>Ingrese una fecha válida.</li> 
                                </ul>
                            </span>
                        </div>
                    </div>
                </div>

                <!--DIA-SEMANA-->
                <div data-mdb-input-init class="form-outline mb-3 shadow-sm bg-white">
                    <div class="input-group">
                        <span class="input-group-text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                                class="bi bi-key" viewBox="0 0 16 16">
                                <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                            </svg>
                        </span>
                        <div class="form-floating">
                            <select name="dia-semana" class="form-select" id="select-dia">
                                <option value="1">Lunes</option>
                                <option value="2">Martes</option>
                                <option value="3">Miércoles</option>
                                <option value="4">Jueves</option>
                                <option value="5">Viernes</option>
                                <option value="6">Sábado</option>
                                <option value="7">Domingo</option>
                            </select>
                            <label for="date">Dia de la semana</label>
                        </div>
                        <div class="form-floating">
                            <select name="hora-clase" class="form-select" id="select-hora">
                                <option selected value="-1"></option>
                                <option value="0">00:00</option>
                                <option value="1">01:00</option>
                                <option value="2">02:00</option>
                                <option value="3">03:00</option>
                                <option value="4">04:00</option>
                                <option value="5">05:00</option>
                                <option value="6">06:00</option>
                                <option value="7">07:00</option>
                                <option value="8">08:00</option>
                                <option value="9">09:00</option>
                                <option value="10">10:00</option>
                                <option value="11">11:00</option>
                                <option value="12">12:00</option>
                                <option value="13">13:00</option>
                                <option value="14">14:00</option>
                                <option value="15">15:00</option>
                                <option value="16">16:00</option>
                                <option value="17">17:00</option>
                                <option value="18">18:00</option>
                                <option value="19">19:00</option>
                                <option value="20">20:00</option>
                                <option value="21">21:00</option>
                                <option value="22">22:00</option>
                                <option value="23">23:00</option>
                                <option value="24">24:00</option>
                            </select>
                            <label for="date">Horario</label>
                        </div>
                    </div>
                </div>

                <!--SUBMIT-->
                <div class="pt-1 mb-2">
                    <input type="button" id="submit" class="btn btn-danger btn-lg" value="Request">
                    <input type="button" id="check" class="btn btn-danger btn-lg" value="Check">
                </div>


            </form>
            <br>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">Día</th>
                        <th scope="col">Horario</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="cursor: pointer;">
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<script>

    selectDia = document.getElementById('select-dia')
    if (selectDia) {
        selectDia.addEventListener('input', evt => { 
            request()
            updateDatepicker()
         })
    }
    updateDatepicker()

    selectHora = document.getElementById('select-hora')
    if (selectHora) {
        selectHora.addEventListener('change', evt => { 
            let dia = selectDia.value
            /*
            let hora = selectHora.value
            console.log(`| ID dia: ${dia} | ID hora: ${hora} |`)
            */
         })
    }

    function request() {
        const route = `/api/horarios/${selectDia.value}`
        $.ajax({
            url: route,
            dataType: 'json',
            async: false,
            success: function(result) {
                console.log(`Ajax: ${typeof(result)}`)
                console.log(result[0])
                let nextIndex = -1
                for (var i = 0; i < selectHora.options.length - 1; i++) {
                    const dato = selectHora.options[i+1]
                    //console.log(`Testeando: ${dato.innerHTML}`)
                        if (result.length == 0) {
                            dato.setAttribute('hidden', true)
                            dato.setAttribute('disabled', true)
                            continue
                        }

                        for(var j = 0; j < result.length; j++) {
                            //console.log(`Iteracion: ${result[j].hora}`)
                            if (dato.innerHTML == result[j].hora) {
                                //console.log(`Coincidencia: ${dato.innerHTML}`)
                                if (nextIndex == -1) {
                                    nextIndex = i
                                }
                                dato.removeAttribute('hidden')
                                dato.removeAttribute('disabled')
                                break
                            }
                            dato.setAttribute('hidden', true)
                            dato.setAttribute('disabled', true)
                        }
                    }
                    console.log(nextIndex)
                    selectHora.value = `${nextIndex}`
            }
        })
    }

        /*
        function updateDatepicker() { 
            $('#date').datepicker({
                beforeShowDay : function (date) { 
                    let day = date.getDay()
                    console.log(day)
                    console.log(selectDia.value)
                    return day == selectDia.value
                },
                format : 'yyyy-mm-dd'
            })
        }
        
        */

    let submit = document.getElementById('submit')
    if (submit) {
        console.log(submit)
        submit.onclick = request
    }

    let check = document.getElementById('check')
    if (check) {
        check.onclick = function () {  
            let dia = selectDia.value
            let hora = selectHora.value
            console.log(`| ID dia: ${dia} | ID hora: ${hora} |`)
        }
    }

</script>
{% endblock %}